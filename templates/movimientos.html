{% extends "base.html" %}

{% block titulo %}Gestión de movimientos{% endblock %}

{% block contenido %}

  <main class="contenedor">

    <div class="panel-izquierdo">
      <div class="registro-container">
        <h3>Saldo Actual: <strong>${{ "{:,.2f}".format(saldo_actual) }}</strong></h3>
        <h3 class="titulo">¿Qué deseas registrar hoy {{ usuario }}?</h3>

        <div class="tipo-selector">
          <button onclick="mostrarFormulario('ingreso')">Ingreso</button>
          <button onclick="mostrarFormulario('gasto')">Gasto</button>
          <button onclick="mostrarFormulario('prestamo')">Préstamo (a alguien)</button>
          <button onclick="mostrarFormulario('deuda')">Deuda (lo que debo)</button>
        </div>

        <!-- Ingreso/Gasto -->
        <form method="POST" action="{{ url_for('movimientos') }}" id="form-movimiento" style="display: none;">
          <input type="hidden" name="tipo" id="tipo">

          <label> Fecha</label>
          <input type="date" name="fecha" required>

          <label>Frecuencia</label>
          <select name="frecuencia">
            <option value="una_vez">Una vez</option>
            <option value="diario">Diario</option>
            <option value="semanal">Semanal</option>
            <option value="mensual">Mensual</option>
          </select>

          <label>Descripción</label>
          <input type="text" name="descripcion" placeholder="Ej: Pago de salario, almuerzo..." required>

          <label>Monto</label>
          <input type="number" name="valor" step="0.01" placeholder="Ej: 25000" required>

          <label>Categoría</label>
            <select name="categoria_id" required>
              {% for categoria in categorias %}
                <option value="{{ categoria.id }}">
                  <i class="{{ categoria.icono }}"></i> {{ categoria.nombre }}
                </option>
              {% endfor %}
            </select>

          <button type="submit" class="guardar-btn">✓ Guardar</button>
        </form>

        <!--Prestamos-->
       <form method="POST" action="{{ url_for('registrar_prestamo') }}" id="form-prestamo" style="display: none;">
          <label>Fecha</label>
          <input type="date" name="fecha" required>

          <label>Frecuencia</label>
          <select name="frecuencia" required>
            <option value="una_vez">Una vez</option>
            <option value="diario">Diario</option>
            <option value="semanal">Semanal</option>
            <option value="mensual">Mensual</option>
          </select>

          <label>Persona</label>
          <input type="text" name="persona" placeholder="¿A quién le prestaste?" required>

          <label>Descripción</label>
          <input type="text" name="descripcion" placeholder="Ej: Préstamo a Juan" required>

          <label>Monto</label>
          <input type="number" name="valor" step="0.01" placeholder="Ej: 25000" required>

          <button type="submit" class="guardar-btn">✓ Guardar</button>
        </form>

        <!-- Deuda -->
        <form method="POST" action="{{ url_for('registrar_deuda') }}" id="form-deuda" style="display: none;">
          <label>Fecha</label>
          <input type="date" name="fecha" required>

          <label>Frecuencia</label>
          <select name="frecuencia">
            <option value="una_vez">Una vez</option>
            <option value="diario">Diario</option>
            <option value="semanal">Semanal</option>
            <option value="mensual">Mensual</option>
          </select>

          <label>A quién le debes</label>
          <input type="text" name="persona" placeholder="Ej: Deuda con Banco X" required>

          <label>Descripción</label>
          <input type="text" name="descripcion" placeholder="Ej: Préstamo del banco" required>

          <label>Monto</label>
          <input type="number" name="valor" step="0.01" placeholder="Ej: 50000" required>

          <button type="submit" class="guardar-btn">✓ Guardar</button>
        </form>
      </div>
    </div>






    <div class="panel-derecho">
      <form method="GET" class="filtros-form">
        <label>Desde:
          <input type="date" name="fecha_desde" value="{{ request.args.get('fecha_desde', '') }}">
        </label>
        <label>Hasta:
          <input type="date" name="fecha_hasta" value="{{ request.args.get('fecha_hasta', '') }}">
        </label>

        <input type="hidden" name="seccion" value="{{ request.args.get('seccion', 'deudas') }}">

        <label>Ordenar por:
          <select name="ordenar">
            <option value="fecha_desc" {% if request.args.get('ordenar') == 'fecha_desc' %}selected{% endif %}>Fecha (desc)</option>
            <option value="fecha_asc" {% if request.args.get('ordenar') == 'fecha_asc' %}selected{% endif %}>Fecha (asc)</option>
            <option value="valor_desc" {% if request.args.get('ordenar') == 'valor_desc' %}selected{% endif %}>Valor (mayor a menor)</option>
            <option value="valor_asc" {% if request.args.get('ordenar') == 'valor_asc' %}selected{% endif %}>Valor (menor a mayor)</option>
          </select>
        </label>

        <button type="submit" formaction="{{ url_for('movimientos') }}">Filtrar</button>
        <button type="submit" formaction="{{ url_for('exportar_pdf') }}">Exportar a PDF</button>
      </form>

      <!-- botones de secciones -->
      <div>
        <button type="button" id="btnIngresos" class="boton-seccion {% if seccion == 'ingresos' %}activo{% endif %}" onclick="cambiarSeccion('ingresos')">
          Ingresos y gastos
        </button>
        <button type="button" id="btnDeudas" class="boton-seccion {% if seccion == 'deudas' %}activo{% endif %}" onclick="cambiarSeccion('deudas')">
          Deudas
        </button>
        <button type="button" id="btnPrestamos" class="boton-seccion {% if seccion == 'prestamos' %}activo{% endif %}" onclick="cambiarSeccion('prestamos')">
          Préstamos
        </button>
      </div>

      <!-- Sección Ingresos y Gastos -->
      <div id="seccionIngresos" class="seccion {% if seccion == 'ingresos' %}activa{% endif %}">
        <div class="tabla-responsive">
          <table class="tabla-movimientos">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Descripción</th>
                <th>Valor</th>
                <th>Tipo</th>
              </tr>
            </thead>
            <tbody>
              {% for item in movimientos if item.tipo in ['ingreso', 'gasto'] %}
                <tr>
                  <td>{{ item.fecha }}</td>
                  <td>{{ item.descripcion }}</td>
                  <td>${{ "%.2f"|format(item.valor) }}</td>
                  <td class="{% if item.tipo == 'ingreso' %}tipo-ingreso{% elif item.tipo == 'gasto' %}tipo-gasto{% endif %}">
                    {{ item.tipo|capitalize }}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Sección Deudas -->
      <div id="seccionDeudas" class="seccion {% if seccion == 'deudas' %}activa{% endif %}">
        <div class="tabla-responsive">
          <table class="tabla-movimientos">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Descripción</th>
                <th>Valor</th>
                <th>Tipo</th>
                <th>Saldo Pendiente</th>
              </tr>
            </thead>
            <tbody>
              {% for item in deudas if item.tipo in ['deuda', 'abono_deuda'] %}
                <tr>
                  <td>{{ item.fecha }}</td>
                  <td>{{ item.descripcion }}</td>
                  <td>
                    {% if item.saldo is not none %}
                      ${{ "%.2f"|format(item.saldo) }}
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  <td class="tipo-{{ item.tipo }}">
                    {{ item.tipo|replace('_', ' ')|capitalize }}
                  </td>
                  <td>
                    {% if item.saldo is defined and item.saldo is not none %}
                      ${{ "%.2f"|format(item.saldo) }}
                    {% else %}
                      -
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Sección Préstamos -->
      <div id="seccionPrestamos" class="seccion {% if seccion == 'prestamos' %}activa{% endif %}">
        <div class="tabla-responsive">
          <table class="tabla-movimientos">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Descripción</th>
                <th>saldo</th>
                <th>Estado</th>
                <th>Saldo Pendiente</th>
                <th>Accion</th>
              </tr>
            </thead>
            <tbody>
              {% for prestamo in prestamos %}
                <tr>
                  <td>{{ prestamo.fecha }}</td>
                  <td>{{ prestamo.descripcion }}</td>
                  <td>${{ "%.2f"|format(prestamo.monto_inicial) }}</td>
                  <td class="
                    {% if prestamo.estado == 'pendiente' %}
                      estado-pendiente
                    {% elif prestamo.estado == 'pagado' %}
                      estado-pagado
                    {% elif prestamo.estado == 'vencido' %}
                      estado-vencido
                    {% else %}
                      estado-otro
                    {% endif %}
                  ">
                    {{ prestamo.estado|capitalize }}
                  </td>
                  <td>${{ "%.2f"|format(prestamo.saldo) }}</td>
                  <td>
                    {% if prestamo.saldo > 0 %}
                      <button type="button" onclick="abrirModalAbono({{ prestamo.id }}, {{ prestamo.saldo }})">Abonar</button>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </main>



<div id="modalAbono" class="modal">
  <div class="modal-contenido">
    <form method="POST" action="{{ url_for('abonar_prestamo') }}">
      <input type="hidden" name="prestamo_id" id="abonoPrestamoId">
      
      <label>Monto a abonar:</label>
      <input type="number" step="0.01" name="monto_abono" required>

      <p>Saldo pendiente: $<span id="saldoPendienteModal"></span></p>

      <button type="submit">Confirmar abono</button>
      <button type="button" onclick="cerrarModalAbono()">Cancelar</button>
    </form>
  </div>
</div>





{% endblock %}

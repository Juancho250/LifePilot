{% extends "base.html" %}

{% block titulo %}Gesti√≥n de movimientos{% endblock %}

{% block contenido %}

  <main class="contenedor">

    <div class="panel-izquierdo">
      <div class="registro-container">
        <h3>Saldo Actual: <strong>${{ "{:,.2f}".format(saldo_actual) }}</strong></h3>
        <h3 class="titulo">¬øQu√© deseas registrar hoy {{ usuario }}?</h3>

        <div class="tipo-selector tarjetas">
          <button onclick="mostrarFormulario('ingreso')" class="tarjeta-btn">
            <i class="fas fa-wallet icono-grande"></i>
            <span>Ingreso</span>
          </button>
          <button onclick="mostrarFormulario('gasto')" class="tarjeta-btn">
            <i class="fas fa-shopping-cart icono-grande"></i>
            <span>Gasto</span>
          </button>
          <button onclick="mostrarFormulario('prestamo')" class="tarjeta-btn">
            <i class="fas fa-hand-holding-usd icono-grande"></i>
            <span>Pr√©stamo</span>
          </button>
          <button onclick="mostrarFormulario('deuda')" class="tarjeta-btn">
            <i class="fas fa-credit-card icono-grande"></i>
            <span>Deuda</span>
          </button>
        </div>

        <!-- Ingreso/Gasto -->
<form method="POST" action="{{ url_for('movimientos') }}" id="form-movimiento" style="display: none;">
  <input type="hidden" name="tipo" id="tipo">

  <label>Fecha</label>
  <input type="date" name="fecha" required id="fecha-mov">

  <label>Frecuencia</label>
  <select name="frecuencia">
    <option value="una_vez">Una vez</option>
    <option value="diario">Diario</option>
    <option value="semanal">Semanal</option>
    <option value="mensual">Mensual</option>
  </select>

  <label>Descripci√≥n</label>
  <input type="text" name="descripcion" placeholder="Ej: Pago de salario, almuerzo..." required id="descripcion-mov">

  <label>Monto</label>
  <input type="number" name="valor" step="0.01" placeholder="Ej: 25000" required id="valor-mov">

  <label>Categor√≠a</label>
  <!-- Mostrar categor√≠as -->
  <div class="categorias-grid">
    {% for categoria in categorias %}
      <input
        type="radio"
        name="categoria_id"
        value="{{ categoria.id }}"
        id="cat{{ categoria.id }}"
        class="categoria-radio"
        required
      >
      <label for="cat{{ categoria.id }}" class="categoria-tarjeta">
        <i class="fa-solid {{ categoria.icono }}"></i><br>
        {{ categoria.nombre }}
      </label>
    {% endfor %}

    <!-- Tarjeta para agregar nueva categor√≠a -->
    <div class="categoria-tarjeta agregar-categoria" onclick="abrirModalCategoria()">
      <i class="fas fa-plus"></i><br>
      Agregar categor√≠a
    </div>
  </div>

  <button type="submit" class="guardar-btn">‚úì Guardar</button>
</form>


        <!--Prestamos-->
        <form method="POST" action="{{ url_for('registrar_prestamo') }}" id="form-prestamo" style="display: none;">
          <label>Fecha</label>
          <input type="date" name="fecha" required id="fecha-prestamo">

          <label>Frecuencia</label>
          <select name="frecuencia" required>
            <option value="una_vez">Una vez</option>
            <option value="diario">Diario</option>
            <option value="semanal">Semanal</option>
            <option value="mensual">Mensual</option>
          </select>

          <label>Persona</label>
          <input type="text" name="persona" placeholder="¬øA qui√©n le prestaste?" required id="persona-prestamo">

          <label>Descripci√≥n</label>
          <input type="text" name="descripcion" placeholder="Ej: Pr√©stamo a Juan" required id="descripcion-prestamo">

          <label>Monto</label>
          <input type="number" name="valor" step="0.01" placeholder="Ej: 25000" required id="valor-prestamo">

          <button type="submit" class="guardar-btn">‚úì Guardar</button>
        </form>

        <!-- Deuda -->
        <form method="POST" action="{{ url_for('registrar_deuda') }}" id="form-deuda" style="display: none;">
          <label>Fecha</label>
          <input type="date" name="fecha" required id="fecha-deuda">

          <label>Frecuencia</label>
          <select name="frecuencia">
            <option value="una_vez">Una vez</option>
            <option value="diario">Diario</option>
            <option value="semanal">Semanal</option>
            <option value="mensual">Mensual</option>
          </select>

          <label>A qui√©n le debes</label>
          <input type="text" name="persona" placeholder="Ej: Deuda con Banco X" required id="persona-deuda">

          <label>Descripci√≥n</label>
          <input type="text" name="descripcion" placeholder="Ej: Pr√©stamo del banco" required id="descripcion-deuda">

          <label>Monto</label>
          <input type="number" name="valor" step="0.01" placeholder="Ej: 50000" required id="valor-deuda">

          <button type="submit" class="guardar-btn">‚úì Guardar</button>
        </form>

        <!-- Bot√≥n de entrada por voz -->
        <div class="voz-entrada-container">
          <button id="btn-voz" class="btn-voz" onclick="toggleReconocimientoVoz()">
            üéôÔ∏è
            <span class="ondas"></span>
          </button>
          <div id="burbuja-input" class="burbuja-input oculto">
            <input type="text" id="textoReconocido" placeholder="Habla ahora..." readonly>
          </div>
        </div>
        
      </div>
    </div>




    <div class="panel-derecho">
      <form method="GET" class="filtros-form">
        <label>Desde:
          <input type="date" name="fecha_desde" value="{{ request.args.get('fecha_desde', '') }}">
        </label>
        <label>Hasta:
          <input type="date" name="fecha_hasta" value="{{ request.args.get('fecha_hasta', '') }}">
        </label>

        <input type="hidden" name="seccion" value="{{ request.args.get('seccion', 'deudas') }}">

        <label>Ordenar por:
          <select name="ordenar">
            <option value="fecha_desc" {% if request.args.get('ordenar') == 'fecha_desc' %}selected{% endif %}>Fecha (desc)</option>
            <option value="fecha_asc" {% if request.args.get('ordenar') == 'fecha_asc' %}selected{% endif %}>Fecha (asc)</option>
            <option value="valor_desc" {% if request.args.get('ordenar') == 'valor_desc' %}selected{% endif %}>Valor (mayor a menor)</option>
            <option value="valor_asc" {% if request.args.get('ordenar') == 'valor_asc' %}selected{% endif %}>Valor (menor a mayor)</option>
          </select>
        </label>

        <button type="submit" formaction="{{ url_for('movimientos') }}">Filtrar</button>
        <button type="submit" formaction="{{ url_for('exportar_pdf') }}">Exportar a PDF</button>
      </form>

      <!-- botones de secciones -->
      <div>
        <button type="button" id="btnIngresos" class="boton-seccion {% if seccion == 'ingresos' %}activo{% endif %}" onclick="cambiarSeccion('ingresos')">
          Ingresos y gastos
        </button>
        <button type="button" id="btnDeudas" class="boton-seccion {% if seccion == 'deudas' %}activo{% endif %}" onclick="cambiarSeccion('deudas')">
          Deudas
        </button>
        <button type="button" id="btnPrestamos" class="boton-seccion {% if seccion == 'prestamos' %}activo{% endif %}" onclick="cambiarSeccion('prestamos')">
          Pr√©stamos
        </button>
      </div>

      <!-- Secci√≥n Ingresos y Gastos -->
      <div id="seccionIngresos" class="seccion {% if seccion == 'ingresos' %}activa{% endif %}">
        <div class="tabla-responsive">
          <table class="tabla-movimientos">
            <tbody>
              {% set contador = 0 %}
              {% for fecha_legible, items in movimientos_agrupados.items() %}
                {% if not mostrar_todo and contador >= 1 %}
                  <tr>
                    <td colspan="3" style="text-align:center;">
                      <a href="{{ url_for('movimientos', ver_todo=1) }}">Ver m√°s movimientos</a>
                    </td>
                  </tr>
                  {# Aqu√≠ no usamos break, simplemente omitimos mostrar m√°s filas #}
                {% else %}
                  <tr>
                    <td colspan="3"><strong>{{ fecha_legible }}</strong></td>
                  </tr>
                  {% for item in items %}
                    <tr class="fila-modal-detalles"
                        data-fecha="{{ item.fecha }}"
                        data-tipo="{{ item.tipo }}"
                        data-estado="{{ item.estado if item.estado else 'desconocido' }}"
                        data-valor="{{ '%.2f'|format(item.valor) }}"
                        data-descripcion="{{ item.descripcion }}">
                      <td>{{ item.fecha }}</td>
                      <td class="{% if item.tipo == 'ingreso' %}tipo-ingreso{% else %}tipo-gasto{% endif %}">
                        {{ item.tipo|capitalize }}
                      </td>
                      <td>${{ '%.2f'|format(item.valor) }}</td>
                    </tr>
                  {% endfor %}
                  {% set contador = contador + 1 %}
                {% endif %}
              {% endfor %}
              {# Si no mostr√°s todo y hay m√°s de un grupo, el link aparecer√° despu√©s del primer grupo #}
              {% if not mostrar_todo and movimientos_agrupados|length > 1 %}
                <tr>
                  <td colspan="3" style="text-align:center;">
                    <a href="{{ url_for('movimientos', ver_todo=1) }}">Ver m√°s movimientos</a>
                  </td>
                </tr>
              {% endif %}
            </tbody>

          </table>
        </div>
      </div>

      <!-- Secci√≥n Deudas -->
      <div id="seccionDeudas" class="seccion {% if seccion == 'deudas' %}activa{% endif %}">
        <div class="tabla-responsive">
          <table class="tabla-movimientos">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Descripci√≥n</th>
                <th>Valor</th>
                <th>Tipo</th>
                <th>Saldo Pendiente</th>
              </tr>
            </thead>
            <tbody>
              {% for item in deudas if item.tipo in ['deuda', 'abono_deuda'] %}
                <tr class="fila-modal-detalles"
                    data-fecha="{{ item.fecha }}"
                    data-descripcion="{{ item.descripcion }}"
                    data-valor="{{ '%.2f'|format(item.monto_inicial if item.monto_inicial is defined else 0) }}"
                    data-tipo="{{ item.tipo }}"
                    data-saldo="{{ '%.2f'|format(item.saldo if item.saldo is defined else 0) }}"
                    data-estado="{{ item.estado if item.estado else 'desconocido' }}">
                  <td>{{ item.fecha }}</td>
                  <td>{{ item.descripcion }}</td>
                  <td>
                    {% if item.monto_inicial is defined %}
                      ${{ "%.2f"|format(item.monto_inicial) }}
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  <td class="tipo-{{ item.tipo }}">
                    {{ item.tipo|replace('_', ' ')|capitalize }}
                  </td>
                  <td>
                    {% if item.saldo is defined and item.saldo is not none %}
                      ${{ "%.2f"|format(item.saldo) }}
                    {% else %}
                      -
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Secci√≥n Pr√©stamos -->
      <div id="seccionPrestamos" class="seccion {% if seccion == 'prestamos' %}activa{% endif %}">
        <div class="tabla-responsive">
          <table class="tabla-movimientos">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Descripci√≥n</th>
                <th>Monto Inicial</th>
                <th>Estado</th>
                <th>Saldo Pendiente</th>
                <th>Acci√≥n</th>
              </tr>
            </thead>
            <tbody>
              {% for prestamo in prestamos %}
                <tr class="fila-modal-detalles"
                    data-id="{{ prestamo.id }}"
                    data-fecha="{{ prestamo.fecha }}"
                    data-descripcion="{{ prestamo.descripcion }}"
                    data-monto_inicial="{{ '%.2f'|format(prestamo.monto_inicial) }}"
                    data-estado="{{ prestamo.estado }}"
                    data-saldo="{{ '%.2f'|format(prestamo.saldo) }}">
                  <td>{{ prestamo.fecha }}</td>
                  <td>{{ prestamo.descripcion }}</td>
                  <td>${{ '%.2f'|format(prestamo.monto_inicial) }}</td>
                  <td class="
                    {% if prestamo.estado == 'pendiente' %}estado-pendiente
                    {% elif prestamo.estado == 'pagado' %}estado-pagado
                    {% elif prestamo.estado == 'vencido' %}estado-vencido
                    {% else %}estado-otro{% endif %}
                  ">
                    {{ prestamo.estado|capitalize }}
                  </td>
                  <td>${{ '%.2f'|format(prestamo.saldo) }}</td>
                  <td>
                    {% if prestamo.saldo > 0 %}
                      <button type="button" onclick="event.stopPropagation(); abrirModalAbono({{ prestamo.id }}, {{ prestamo.saldo }})">Abonar</button>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>


    </div>
  </main>



  <div id="modalAbono" class="modal">
    <div class="modal-contenido">
      <form method="POST" action="{{ url_for('abonar_prestamo') }}">
        <input type="hidden" name="prestamo_id" id="abonoPrestamoId">
        
        <label>Monto a abonar:</label>
        <input type="number" step="0.01" name="monto_abono" required>

        <p>Saldo pendiente: $<span id="saldoPendienteModal"></span></p>

        <button type="submit">Confirmar abono</button>
        <button type="button" onclick="cerrarModalAbono()">Cancelar</button>
      </form>
    </div>
  </div>

  <div id="modal-detalles" class="modal-detalles" aria-hidden="true" role="dialog" aria-labelledby="modal-detalles-titulo">
    <div class="modal-detalles-contenido">
      <button class="modal-detalles-cerrar" aria-label="Cerrar modal" onclick="cerrarModalDetalles()">&times;</button>
      <h2 id="modal-detalles-titulo">Detalles</h2>
      <div id="modal-detalles-contenido-info">
        <!-- Aqu√≠ se llenan los datos din√°micamente -->
      </div>
    </div>
  </div>

  <!-- Modal personalizado para crear categor√≠a -->
  <div id="modalCategoria" class="modal-categoria">
    <div class="modal-categoria-contenido">
      <!-- Bot√≥n X -->
      <span class="cerrar-modal" onclick="cerrarModalCategoria()">&times;</span>

      <h3>Crear nueva categor√≠a</h3>
      <form id="formCrearCategoria" method="POST" action="{{ url_for('crear_categoria') }}">

        <label>Nombre:</label>
        <input type="text" id="nombreCategoria" name="nombre" required oninput="sugerirIconos()">

        <label>√çcono:</label>
        <div id="iconoSelector" class="icono-selector"></div>
        <input type="hidden" name="icono" id="iconoInput" required>

        <div style="margin-top: 15px;">
          <button type="submit" class="guardar-btn">Guardar</button>
        </div>
      </form>
    </div>
  </div>





{% endblock %}
